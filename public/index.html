<!DOCTYPE html>
<html>
<head>
    <title>æ•…éšœç‰©æ–™æŸ¥è¯¢å·¥å…· - é™æ€åŠ é€Ÿç‰ˆ</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no, email=no, address=no">
    
    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js" onerror="this.onerror=null;this.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" onerror="this.onerror=null;this.src='https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js';"></script>
    <!-- é™æ€æ•°æ®æ–‡ä»¶ï¼ˆç”±æ„å»ºè„šæœ¬ç”Ÿæˆï¼‰ -->
    <script src="/data.js"></script>
    
    <style>
        /* ===== åŸæœ‰CSSå®Œå…¨ä¿ç•™ï¼Œæœªåšä»»ä½•ç¾åŒ–ä¿®æ”¹ ===== */
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', 'Hiragino Sans GB', 'Helvetica Neue', Arial, sans-serif;
            padding: 15px;
            background-color: #f5f7fa;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 100px;
        }
        h1 {
            color: #2c5282;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .model-selector {
            width: 100%;
            padding: 14px 20px;
            font-size: 16px;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            margin-bottom: 15px;
            background-color: white;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        .model-selector:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        .tab-btn {
            flex: 1;
            padding: 14px;
            text-align: center;
            background-color: #f7fafc;
            border: none;
            font-size: 16px;
            font-weight: 500;
            color: #718096;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background-color: #4299e1;
            color: white;
        }
        .tab-btn:not(.active):hover {
            background-color: #e2e8f0;
        }
        
        .search-container {
            margin-bottom: 10px;
        }
        #searchBox, #materialSearchBox {
            width: 100%;
            padding: 16px 20px;
            font-size: 18px;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
            outline: none;
            -webkit-appearance: none;
        }
        #searchBox:focus, #materialSearchBox:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        #searchBox:disabled, #materialSearchBox:disabled {
            background-color: #edf2f7;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        #faultResult, #materialResult {
            margin-top: 25px;
            min-height: 60px;
        }
        .fault-item {
            background: white;
            border-radius: 10px;
            padding: 0;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .fault-title {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        .material-list {
            padding: 15px;
        }
        .material-item {
            padding: 12px 15px;
            border-bottom: 1px dashed #e2e8f0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .material-item:last-child { border-bottom: none; }
        .seq {
            background-color: #edf2f7;
            color: #4a5568;
            font-weight: bold;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .material-name {
            font-weight: 500;
            flex-grow: 1;
            margin-right: 10px;
            word-break: break-word;
        }
        .material-code {
            background-color: #fffacd;
            color: #744210;
            padding: 4px 10px;
            border-radius: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-top: 5px;
            width: 100%;
            border: 1px solid #f6e05e;
            word-break: break-all;
        }
        .material-location {
            background-color: #e6f7ff;
            color: #006d75;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 13px;
            margin-top: 5px;
            width: 100%;
            border: 1px solid #87e8de;
        }
        .no-result, .hint {
            text-align: center;
            padding: 30px;
            color: #718096;
            font-size: 16px;
            line-height: 1.5;
        }
        .hint { font-size: 14px; color: #a0aec0; }
        .highlight { background-color: #ffeb3b; padding: 0 2px; }
        .model-indicator {
            display: inline-block;
            background-color: #4299e1;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .material-search-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }
        .material-info {
            margin-bottom: 10px;
        }
        .material-search-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
            color: #2d3748;
        }
        .appears-in {
            font-size: 13px;
            color: #718096;
            margin-top: 8px;
        }
        .appears-in-title {
            font-weight: 500;
            color: #4a5568;
        }
        .fault-code-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 5px;
        }
        .fault-code-tag {
            background-color: #edf2f7;
            color: #4a5568;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* åé¦ˆæŒ‰é’®ç»„ */
        .feedback-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(237, 137, 54, 0.4);
            transition: all 0.3s;
            z-index: 100;
        }
        .feedback-btn:hover {
            background: linear-gradient(135deg, #f6ad55, #ed8936);
            box-shadow: 0 6px 16px rgba(237, 137, 54, 0.5);
            transform: translateY(-2px);
        }
        
        .admin-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, #38a169, #2f855a);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.4);
            transition: all 0.3s;
            z-index: 100;
            display: none;  /* é»˜è®¤éšè— */
        }
        .admin-btn:hover {
            background: linear-gradient(135deg, #48bb78, #38a169);
            box-shadow: 0 6px 16px rgba(56, 161, 105, 0.5);
            transform: translateY(-2px);
        }
        
        .stats-btn {
            position: fixed;
            bottom: 140px;
            right: 20px;
            background: linear-gradient(135deg, #9f7aea, #805ad5);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(159, 122, 234, 0.4);
            transition: all 0.3s;
            z-index: 100;
            display: none;  /* é»˜è®¤éšè— */
        }
        .stats-btn:hover {
            background: linear-gradient(135deg, #b794f4, #9f7aea);
            box-shadow: 0 6px 16px rgba(159, 122, 234, 0.5);
            transform: translateY(-2px);
        }
        
        .view-reply-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: auto;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.4);
            transition: all 0.3s;
            z-index: 100;
            display: none;  /* æœ‰å›å¤æ—¶æ˜¾ç¤º */
        }
        .view-reply-btn:hover {
            background: linear-gradient(135deg, #63b3ed, #4299e1);
            box-shadow: 0 6px 16px rgba(66, 153, 225, 0.5);
            transform: translateY(-2px);
        }
        
        .reply-admin-btn {
            position: fixed;
            bottom: 260px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #5a67d8);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 100;
            display: none;  /* é»˜è®¤éšè— */
        }
        .reply-admin-btn:hover {
            background: linear-gradient(135deg, #7f9cf5, #667eea);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }
        
        /* æ•°æ®ç®¡ç†æŒ‰é’®ï¼ˆç®¡ç†å‘˜ï¼‰ */
        #dataManageBtn {
            position: fixed;
            bottom: 320px;
            right: 20px;
            background: linear-gradient(135deg, #805ad5, #6b46c1);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(128, 90, 213, 0.4);
            transition: all 0.3s;
            z-index: 100;
            display: none;  /* é»˜è®¤éšè— */
        }
        #dataManageBtn:hover {
            background: linear-gradient(135deg, #9f7aea, #805ad5);
            box-shadow: 0 6px 16px rgba(128, 90, 213, 0.5);
            transform: translateY(-2px);
        }
        
        /* åé¦ˆæ¨¡æ€æ¡†æ ·å¼ */
        .feedback-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .feedback-modal.active {
            display: flex;
        }
        .feedback-content {
            background-color: white;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.3s ease-out;
        }
        @keyframes modalAppear {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .feedback-header {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .feedback-header h2 {
            margin: 0;
            font-size: 20px;
        }
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
        }
        .feedback-body {
            padding: 25px;
        }
        .feedback-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group label {
            font-weight: 600;
            color: #4a5568;
        }
        .form-group select, .form-group textarea {
            padding: 14px;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            outline: none;
        }
        .form-group select:focus, .form-group textarea:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        .form-group .hint-text {
            font-size: 13px;
            color: #718096;
            margin-top: 4px;
        }
        .feedback-actions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .feedback-actions button {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .submit-btn {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
        }
        .submit-btn:hover {
            background: linear-gradient(135deg, #3182ce, #2b6cb0);
        }
        .cancel-btn {
            background-color: #edf2f7;
            color: #4a5568;
            border: 2px solid #cbd5e0;
        }
        .cancel-btn:hover {
            background-color: #e2e8f0;
        }
        
        .success-message {
            display: none;
            text-align: center;
            padding: 40px 25px;
        }
        .success-message.active {
            display: block;
        }
        .success-icon {
            font-size: 60px;
            color: #48bb78;
            margin-bottom: 20px;
        }
        .success-message h3 {
            color: #2f855a;
            margin-bottom: 15px;
        }
        .success-message p {
            color: #718096;
            line-height: 1.5;
        }
        .back-to-form {
            background-color: #48bb78;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        .back-to-form:hover {
            background-color: #38a169;
        }
        
        /* å›å¤é€šçŸ¥æ¡† */
        .reply-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.4);
            z-index: 1000;
            max-width: 400px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .reply-notification h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        .reply-content {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
        }
        .reply-time {
            font-size: 12px;
            opacity: 0.8;
            text-align: right;
        }
        .close-reply {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .spinner {
            border: 6px solid #e2e8f0;
            border-top: 6px solid #4299e1;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        .loading-text {
            color: #2d3748;
            font-size: 18px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”»å±‚ -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™...</div>
    </div>

    <h1>ğŸ”§ æ•…éšœä¸ç‰©æ–™æŸ¥è¯¢ <span id="currentModel" class="model-indicator">J1</span></h1>
    
    <!-- å‹å·é€‰æ‹©ä¸‹æ‹‰æ¡† -->
    <select class="model-selector" id="modelSelector">
        <option value="J1">J1 å‹å·</option>
        <option value="J2">J2 å‹å·</option>
        <option value="J3">J3 å‹å·</option>
        <option value="J4">J4 å‹å·</option>
        <option value="J4Lite">J4Lite å‹å·</option>
        <option value="R10">R10 å‹å·</option>
        <option value="J5">J5 å‹å·</option>
        <option value="J5X">J5X å‹å·</option>
        <option value="J5Max">J5Max å‹å·</option>
        <option value="J5MaxCB">J5Max è¶…è–„å…¨èƒ½åŸºç«™</option>
        <option value="XY001">é€é¥001 å‹å·</option>
        <option value="XY001Max">é€é¥001Max å‹å·</option>
        <option value="XY002">é€é¥002 å‹å·</option>
        <option value="XY002CB">é€é¥002 è¶…è–„å…¨èƒ½åŸºç«™</option>
        <option value="XY002Max">é€é¥002Max å‹å·</option>
        <option value="XY002MaxCB">é€é¥002Max è¶…è–„å…¨èƒ½åŸºç«™</option>
        <option value="J6">J6 å‹å·</option>
        <option value="J6CB">J6 è¶…è–„å…¨èƒ½åŸºç«™</option>
    </select>
    
    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
    <div class="tab-container">
        <button class="tab-btn active" data-tab="fault">æŒ‰æ•…éšœæŸ¥è¯¢</button>
        <button class="tab-btn" data-tab="material">æŒ‰å¤‡ä»¶æŸ¥è¯¢</button>
    </div>
    
    <!-- æ•…éšœæŸ¥è¯¢å†…å®¹ -->
    <div class="tab-content active" id="faultTab">
        <div class="search-container">
            <input type="text" id="searchBox" placeholder="è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼šåŸºç«™ä¸é€šç”µã€3020..." autocomplete="off">
        </div>
        <div id="faultResult">
            <div class="hint">è¾“å…¥æ•…éšœæè¿°æˆ–ä»£ç ï¼Œç³»ç»Ÿå°†è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚<br>ä¾‹å¦‚è¾“å…¥"åŸºç«™"æˆ–"æ¸…æ°´ç®±"å³å¯æœç´¢ç›¸å…³æ•…éšœã€‚</div>
        </div>
    </div>
    
    <!-- ç‰©æ–™æŸ¥è¯¢å†…å®¹ -->
    <div class="tab-content" id="materialTab">
        <div class="search-container">
            <input type="text" id="materialSearchBox" placeholder="è¯·è¾“å…¥å¤‡ä»¶åç§°ï¼Œå¦‚ï¼šæ°”æ³µç»„ä»¶ã€ç”µæºçº¿..." autocomplete="off">
        </div>
        <div id="materialResult">
            <div class="hint">è¾“å…¥å¤‡ä»¶åç§°ï¼Œç³»ç»Ÿå°†è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚<br>ä¾‹å¦‚è¾“å…¥"æ°”æ³µ"æˆ–"ç”µæºçº¿"å³å¯æœç´¢ç›¸å…³å¤‡ä»¶ä¿¡æ¯ã€‚</div>
        </div>
    </div>

    <!-- åŠŸèƒ½æŒ‰é’®åŒºåŸŸ -->
    <button class="view-reply-btn" id="viewReplyBtn">ğŸ“¨ é—®é¢˜å›å¤</button>
    <button class="stats-btn" id="statsBtn">ğŸ“ˆ å¯¼å‡ºç»Ÿè®¡</button>
    <button class="admin-btn" id="adminBtn">ğŸ“Š å¯¼å‡ºExcel</button>
    <button class="reply-admin-btn" id="replyAdminBtn">ğŸ’¬ å›å¤åé¦ˆ</button>
    <button class="feedback-btn" id="feedbackBtn">ğŸ“ é—®é¢˜åé¦ˆ</button>
    
    <!-- å›å¤é€šçŸ¥ -->
    <div class="reply-notification" id="replyNotification">
        <button class="close-reply" id="closeReply">&times;</button>
        <h3>ğŸ“¨ æ‚¨æœ‰æ–°çš„å›å¤</h3>
        <div class="reply-content" id="replyContent"></div>
        <div class="reply-time" id="replyTime"></div>
    </div>
    
    <!-- åé¦ˆæ¨¡æ€æ¡† -->
    <div class="feedback-modal" id="feedbackModal">
        <div class="feedback-content">
            <div class="feedback-form-wrapper" id="feedbackForm">
                <div class="feedback-header">
                    <h2>é—®é¢˜åé¦ˆä¸å»ºè®®</h2>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
                <div class="feedback-body">
                    <form class="feedback-form" id="feedbackFormElement">
                        <div class="form-group">
                            <label for="feedbackModel">é—®é¢˜1ï¼šåé¦ˆé—®é¢˜å‹å·ï¼Ÿ</label>
                            <select id="feedbackModel" required>
                                <option value="">è¯·é€‰æ‹©å‹å·</option>
                            </select>
                            <div class="hint-text">è¯·é€‰æ‹©æ‚¨é‡åˆ°é—®é¢˜çš„äº§å“å‹å·</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="feedbackProblem">é—®é¢˜2ï¼šå…·ä½“é—®é¢˜ï¼Ÿ</label>
                            <textarea id="feedbackProblem" placeholder="ä¾‹å¦‚ï¼š3001æ²¡æœ‰æ•…éšœç‰©æ–™ï¼›æ°”é˜€æ²¡æœ‰æ–™å·ï¼›æ¸…æ°´ç®±æ•…éšœç¼ºå°‘å¯¹åº”ç‰©æ–™..." required></textarea>
                            <div class="hint-text">è¯·è¯¦ç»†æè¿°é‡åˆ°çš„é—®é¢˜ï¼Œå¦‚æ•…éšœç ç¼ºå°‘ç‰©æ–™ã€å¤‡ä»¶æ²¡æœ‰æ–™å·ç­‰</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="feedbackSuggestion">é—®é¢˜3ï¼šå…¶ä»–åŠŸèƒ½å»ºè®®</label>
                            <textarea id="feedbackSuggestion" placeholder="ä¾‹å¦‚ï¼šå¸Œæœ›å¢åŠ XXå‹å·çš„æ•°æ®ï¼›å¸Œæœ›æ¨å‡ºå…¶ä»–åŠŸèƒ½..."></textarea>
                            <div class="hint-text">æ‚¨å¯¹æŸ¥è¯¢å·¥å…·çš„å…¶ä»–æ”¹è¿›å»ºè®®ï¼ˆå¯é€‰ï¼‰</div>
                        </div>
                        
                        <div class="feedback-actions">
                            <button type="button" class="cancel-btn" id="cancelFeedback">å–æ¶ˆ</button>
                            <button type="submit" class="submit-btn">æäº¤åé¦ˆ</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="success-message" id="successMessage">
                <div class="success-icon">âœ“</div>
                <h3>åé¦ˆæäº¤æˆåŠŸï¼</h3>
                <p>æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†æ‚¨çš„é—®é¢˜å’Œå»ºè®®ã€‚</p>
                <button class="back-to-form" id="backToForm">ç»§ç»­åé¦ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜æ•°æ®ç®¡ç†é¢æ¿ -->
    <div id="adminDataPanel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 1400px; height: 90%; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 2000; overflow-y: auto; padding: 24px; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin:0; color: #2c5282;">ğŸ“‹ æ•…éšœæ•°æ®ç®¡ç† - <span id="adminModelName"></span></h2>
            <button onclick="closeAdminPanel()" style="background: none; border: none; font-size: 32px; cursor: pointer; color: #718096;">&times;</button>
        </div>
        <hr>
        <div style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
            <button class="admin-action-btn" onclick="exportCurrentModelData()">ğŸ“¤ å¯¼å‡ºå½“å‰å‹å·Excel</button>
            <button class="admin-action-btn" onclick="importModelDataPrompt()">ğŸ“¥ å¯¼å…¥Excelï¼ˆæ›¿æ¢å…¨éƒ¨ï¼‰</button>
            <button class="admin-action-btn" onclick="addFaultPrompt()">â• æ–°å¢æ•…éšœ</button>
            <button class="admin-action-btn" onclick="refreshAdminPanel()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <button class="admin-action-btn" onclick="triggerStaticDataUpdate()">ğŸ“¦ æ›´æ–°é™æ€æ•°æ®</button>
        </div>
        <div id="faultAdminList" style="display: flex; flex-direction: column; gap: 20px;"></div>
    </div>

    <!-- å¯¼å…¥Excelçš„æ–‡ä»¶é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="importExcelModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2500; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%;">
            <h3 style="margin-top:0;">ğŸ“¥ å¯¼å…¥Excel</h3>
            <p style="color: #4a5568;">è¯·é€‰æ‹©åŒ…å«æ•…éšœæ•°æ®çš„Excelæ–‡ä»¶ï¼Œæ ¼å¼éœ€ä¸å¯¼å‡ºçš„Excelä¸€è‡´ã€‚</p>
            <input type="file" id="excelUploadFile" accept=".xlsx, .xls" style="margin: 20px 0;">
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="cancelImport()" style="padding: 10px 20px; border: 1px solid #cbd5e0; background: white; border-radius: 8px;">å–æ¶ˆ</button>
                <button onclick="confirmImport()" style="padding: 10px 20px; background: #4299e1; color: white; border: none; border-radius: 8px;">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <script>
        // ================ å…¨å±€å˜é‡ ================
        // é™æ€æ•°æ®ç”± /data.js æä¾›ï¼ŒæŒ‚è½½åœ¨ window.__STATIC_DATA
        let staticData = window.__STATIC_DATA || {};  // æ ¼å¼ï¼š{ "J1": [ { code, materials } ] }

        // Supabase å®¢æˆ·ç«¯ï¼ˆç®¡ç†å‘˜åŠŸèƒ½éœ€è¦ï¼‰
        const SUPABASE_URL = 'https://rbuwdmkxqjadqxwzgqlx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJidXdkbWt4cWphZHF4d3pncWx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzY0MzcsImV4cCI6MjA4NjE1MjQzN30.d_s44YrgWImufccCBTwl4tFSfsWXOZhfA-NkYRtSBUc';
        let supabaseClient = null;

        async function initSupabaseClient() {
            if (supabaseClient) return supabaseClient;
            try {
                if (typeof window.supabase === 'undefined') {
                    console.error('Supabaseåº“æœªåŠ è½½');
                    return null;
                }
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                return supabaseClient;
            } catch (error) {
                console.error('åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯å¤±è´¥:', error);
                return null;
            }
        }
        async function getSupabase() {
            if (!supabaseClient) return await initSupabaseClient();
            return supabaseClient;
        }

        // ================ ä»é™æ€æ•°æ®è·å–å‹å·å’Œæ•…éšœ ================
        function getModelsFromStaticData() {
            return Object.keys(staticData).map(code => ({ code }));
        }

        function getFaultsByModel(modelCode) {
            return staticData[modelCode] || [];
        }

        // ================ é¡µé¢å…ƒç´ å¼•ç”¨ ================
        const searchBox = document.getElementById('searchBox');
        const materialSearchBox = document.getElementById('materialSearchBox');
        const faultResultDiv = document.getElementById('faultResult');
        const materialResultDiv = document.getElementById('materialResult');
        const modelSelector = document.getElementById('modelSelector');
        const currentModelIndicator = document.getElementById('currentModel');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        let currentData = []; // å½“å‰å‹å·çš„æ•…éšœæ•°æ®ï¼ˆç”¨äºæœç´¢ï¼‰

        // åŠ è½½çŠ¶æ€æ§åˆ¶
        function setLoading(loading) {
            if (loadingOverlay) loadingOverlay.style.display = loading ? 'flex' : 'none';
            if (searchBox) searchBox.disabled = loading;
            if (materialSearchBox) materialSearchBox.disabled = loading;
        }

        // å‹å·åˆ‡æ¢äº‹ä»¶
        modelSelector.addEventListener('change', function() {
            const selectedModel = modelSelector.value;
            currentData = getFaultsByModel(selectedModel);
            updatePlaceholder();
            updateModelIndicator();
            searchBox.value = '';
            materialSearchBox.value = '';
            faultResultDiv.innerHTML = '<div class="hint">è¾“å…¥æ•…éšœæè¿°æˆ–ä»£ç ï¼Œç³»ç»Ÿå°†è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚<br>ä¾‹å¦‚è¾“å…¥"åŸºç«™"æˆ–"æ¸…æ°´ç®±"å³å¯æœç´¢ç›¸å…³æ•…éšœã€‚</div>';
            materialResultDiv.innerHTML = '<div class="hint">è¾“å…¥å¤‡ä»¶åç§°ï¼Œç³»ç»Ÿå°†è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚<br>ä¾‹å¦‚è¾“å…¥"æ°”æ³µ"æˆ–"ç”µæºçº¿"å³å¯æœç´¢ç›¸å…³å¤‡ä»¶ä¿¡æ¯ã€‚</div>';
            console.log(`åˆ‡æ¢å‹å·: ${selectedModel}, æ•°æ®é‡: ${currentData.length}`);
        });

        // æ›´æ–°å ä½ç¬¦
        function updatePlaceholder() {
            const model = modelSelector.value;
            if (model === 'J1') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š3020ã€åŸºç«™ä¸é€šç”µ...';
            else if (model === 'J2') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š5019ã€åŸºç«™ä¸é€šç”µ...';
            else if (model === 'J3') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š3000ã€åŸºç«™ä¸é€šç”µ...';
            else if (model === 'J4') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š3002ã€åŸºç«™ä¸é€šç”µ...';
            else if (model === 'J4Lite') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š3001ã€åŸºç«™ä¸é€šç”µ...';
            else if (model === 'J5') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š1027ã€åŸºç«™æº¢æ°´...';
            else if (model === 'J5X') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š1027ã€åŸºç«™å¼‚å¸¸...';
            else if (model === 'J5Max') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š1027ã€åŸºç«™å¼‚å¸¸...';
            else if (model === 'J5MaxCB') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š3000ã€åŸºç«™å¼‚å¸¸...';
            else if (model === 'XY001') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š1027ã€åŸºç«™å¼‚å¸¸...';
            else if (model === 'XY001Max') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š1027ã€åŸºç«™å¼‚å¸¸...';
            else if (model === 'XY002') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š2003ã€åŸºç«™ä¸é€šç”µ...';
            else if (model === 'XY002CB') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š3002ã€åŸºç«™ä¸é€šç”µ...';
            else if (model === 'XY002Max') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š2017ã€åŸºç«™ä¸é€šç”µ...';
            else if (model === 'XY002MaxCB') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š3000ã€åŸºç«™ä¸é€šç”µ...';
            else if (model === 'J6') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š2003ã€åŸºç«™ä¸é€šç”µ...';
            else if (model === 'J6CB') searchBox.placeholder = 'è¯·è¾“å…¥æ•…éšœæè¿°ï¼Œå¦‚ï¼š3002ã€åŸºç«™ä¸é€šç”µ...';
        }

        function updateModelIndicator() {
            currentModelIndicator.textContent = modelSelector.value;
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        tabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                tabBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(tabId + 'Tab').classList.add('active');
                if (tabId === 'fault') {
                    materialResultDiv.innerHTML = '<div class="hint">è¾“å…¥å¤‡ä»¶åç§°ï¼Œç³»ç»Ÿå°†è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚<br>ä¾‹å¦‚è¾“å…¥"æ°”æ³µ"æˆ–"ç”µæºçº¿"å³å¯æœç´¢ç›¸å…³å¤‡ä»¶ä¿¡æ¯ã€‚</div>';
                    materialSearchBox.value = '';
                } else {
                    faultResultDiv.innerHTML = '<div class="hint">è¾“å…¥æ•…éšœæè¿°æˆ–ä»£ç ï¼Œç³»ç»Ÿå°†è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚<br>ä¾‹å¦‚è¾“å…¥"åŸºç«™"æˆ–"æ¸…æ°´ç®±"å³å¯æœç´¢ç›¸å…³æ•…éšœã€‚</div>';
                    searchBox.value = '';
                }
            });
        });

        // ================ æœç´¢åŠŸèƒ½ ================
        function performFaultSearch(searchTerm) {
            if (!searchTerm.trim()) {
                faultResultDiv.innerHTML = '<div class="hint">è¾“å…¥æ•…éšœæè¿°æˆ–ä»£ç ï¼Œç³»ç»Ÿå°†è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚<br>ä¾‹å¦‚è¾“å…¥"åŸºç«™"æˆ–"æ¸…æ°´ç®±"å³å¯æœç´¢ç›¸å…³æ•…éšœã€‚</div>';
                return;
            }
            const upperSearchTerm = searchTerm.toUpperCase();
            let hasResult = false;
            faultResultDiv.innerHTML = '';
            currentData.forEach(fault => {
                if (fault.code.toUpperCase().includes(upperSearchTerm)) {
                    hasResult = true;
                    const faultElement = document.createElement('div');
                    faultElement.className = 'fault-item';
                    const highlightedTitle = highlightMatch(fault.code, searchTerm);
                    faultElement.innerHTML = `<div class="fault-title">${highlightedTitle}</div><div class="material-list"></div>`;
                    const materialList = faultElement.querySelector('.material-list');
                    fault.materials.forEach(material => {
                        const materialItem = document.createElement('div');
                        materialItem.className = 'material-item';
                        materialItem.innerHTML = `
                            <div class="seq">${material.seq || '1'}</div>
                            <div class="material-name">${material.name || ''}</div>
                            <div class="material-code">${material.code || ''}</div>
                            <div class="material-location">${material.location || ''}</div>
                        `;
                        materialList.appendChild(materialItem);
                    });
                    faultResultDiv.appendChild(faultElement);
                }
            });
            if (!hasResult) {
                faultResultDiv.innerHTML = `<div class="no-result">æœªæ‰¾åˆ°åŒ…å« "<strong>${searchTerm}</strong>" çš„æ•…éšœä¿¡æ¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–å°è¯•å…¶ä»–å…³é”®è¯ã€‚</div>`;
            }
        }

        function performMaterialSearch(searchTerm) {
            if (!searchTerm.trim()) {
                materialResultDiv.innerHTML = '<div class="hint">è¾“å…¥å¤‡ä»¶åç§°ï¼Œç³»ç»Ÿå°†è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ã€‚<br>ä¾‹å¦‚è¾“å…¥"æ°”æ³µ"æˆ–"ç”µæºçº¿"å³å¯æœç´¢ç›¸å…³å¤‡ä»¶ä¿¡æ¯ã€‚</div>';
                return;
            }
            const upperSearchTerm = searchTerm.toUpperCase();
            let hasResult = false;
            const materialMap = new Map();
            currentData.forEach(fault => {
                fault.materials.forEach(material => {
                    if (material.name && material.name.toUpperCase().includes(upperSearchTerm)) {
                        const materialKey = material.code || material.name;
                        if (!materialMap.has(materialKey)) {
                            materialMap.set(materialKey, {
                                name: material.name,
                                code: material.code,
                                location: material.location,
                                faults: [fault.code]
                            });
                        } else {
                            const existing = materialMap.get(materialKey);
                            if (!existing.faults.includes(fault.code)) existing.faults.push(fault.code);
                        }
                        hasResult = true;
                    }
                });
            });
            if (hasResult) {
                materialResultDiv.innerHTML = '';
                const materialArray = Array.from(materialMap.values()).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                materialArray.forEach(material => {
                    const materialElement = document.createElement('div');
                    materialElement.className = 'material-search-item';
                    const highlightedName = highlightMatch(material.name, searchTerm);
                    const faultTags = material.faults.map(fc => `<span class="fault-code-tag">${highlightMatch(fc, searchTerm)}</span>`).join('');
                    materialElement.innerHTML = `
                        <div class="material-info">
                            <div class="material-search-name">${highlightedName}</div>
                            <div class="material-code">${material.code || ''}</div>
                            <div class="material-location">${material.location || ''}</div>
                        </div>
                        <div class="appears-in">
                            <span class="appears-in-title">å‡ºç°åœ¨ä»¥ä¸‹æ•…éšœä¸­ï¼š</span>
                            <div class="fault-code-list">${faultTags}</div>
                        </div>
                    `;
                    materialResultDiv.appendChild(materialElement);
                });
            } else {
                materialResultDiv.innerHTML = `<div class="no-result">æœªæ‰¾åˆ°åŒ…å« "<strong>${searchTerm}</strong>" çš„å¤‡ä»¶ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–å°è¯•å…¶ä»–å…³é”®è¯ã€‚</div>`;
            }
        }

        function highlightMatch(text, searchTerm) {
            if (!searchTerm.trim() || !text) return text || '';
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // é˜²æŠ–
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        if (searchBox) searchBox.addEventListener('input', debounce(e => performFaultSearch(e.target.value), 300));
        if (materialSearchBox) materialSearchBox.addEventListener('input', debounce(e => performMaterialSearch(e.target.value), 300));

        // ================ ç®¡ç†å‘˜è®¤è¯ ================
        function isAdminAuthenticated() {
            return sessionStorage.getItem('adminAuthenticated') === 'true';
        }

        function showAdminPanel() {
            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼ˆåˆå§‹å¯†ç ï¼š123456ï¼‰ï¼š');
            if (password === '123456') {
                sessionStorage.setItem('adminAuthenticated', 'true');
                sessionStorage.setItem('adminPassword', password);
                
                if (adminBtn) adminBtn.style.display = 'block';
                if (statsBtn) statsBtn.style.display = 'block';
                if (replyAdminBtn) replyAdminBtn.style.display = 'block';
                
                const dataManageBtn = document.getElementById('dataManageBtn');
                if (dataManageBtn) dataManageBtn.style.display = 'block';
                
                alert('ç®¡ç†å‘˜åŠŸèƒ½å·²æ¿€æ´»ï¼');
            } else if (password) {
                alert('å¯†ç é”™è¯¯ï¼');
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                e.preventDefault();
                showAdminPanel();
            }
        });

        // ================ è·å–åŸå§‹æ•…éšœæ•°æ®ï¼ˆç®¡ç†å‘˜é¢æ¿ç”¨ï¼‰ ================
        async function fetchRawFaultsByModel(modelCode) {
            const supabase = await getSupabase();
            if (!supabase) return [];
            const { data: modelData, error: modelError } = await supabase
                .from('models')
                .select('id')
                .eq('code', modelCode)
                .single();
            if (modelError || !modelData) {
                console.error('è·å–å‹å·IDå¤±è´¥', modelError);
                return [];
            }
            const modelId = modelData.id;
            const { data: faults, error } = await supabase
                .from('faults')
                .select(`
                    id,
                    code,
                    materials ( id, seq, name, code, location, usage_rate )
                `)
                .eq('model_id', modelId)
                .order('id', { ascending: true });
            if (error) {
                console.error('è·å–åŸå§‹æ•…éšœæ•°æ®å¤±è´¥:', error);
                return [];
            }
            return faults;
        }

        // ================ ç®¡ç†å‘˜æ•°æ®é¢æ¿åŠŸèƒ½ ================
        function showAdminDataPanel() {
            if (!isAdminAuthenticated()) {
                alert('è¯·å…ˆè¿›è¡Œç®¡ç†å‘˜è®¤è¯ï¼');
                showAdminPanel();
                return;
            }
            document.getElementById('adminDataPanel').style.display = 'flex';
            refreshAdminPanel();
        }

        function closeAdminPanel() {
            document.getElementById('adminDataPanel').style.display = 'none';
        }

        async function refreshAdminPanel() {
            const modelCode = modelSelector.value;
            document.getElementById('adminModelName').innerText = modelCode;
            const faults = await fetchRawFaultsByModel(modelCode);
            
            const container = document.getElementById('faultAdminList');
            if (!faults || faults.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#718096;">æš‚æ— æ•…éšœæ•°æ®ï¼Œè¯·ç‚¹å‡»â€œæ–°å¢æ•…éšœâ€æ·»åŠ ã€‚</div>';
                return;
            }

            let html = '';
            faults.forEach(fault => {
                html += `
                    <div class="admin-fault-card" style="background: #f7fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <strong style="font-size: 18px; color: #2d3748;">${fault.code}</strong>
                            <div>
                                <button onclick="editFault('${fault.id}', '${fault.code.replace(/'/g, "\\'")}')" style="background: #4299e1; color: white; border: none; border-radius: 6px; padding: 6px 14px; margin-right: 8px;">âœï¸ ç¼–è¾‘</button>
                                <button onclick="deleteFault('${fault.id}')" style="background: #f56565; color: white; border: none; border-radius: 6px; padding: 6px 14px;">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px;">
                                <thead>
                                    <tr style="background: #edf2f7; color: #4a5568;">
                                        <th style="padding: 12px; text-align: left;">åºå·</th>
                                        <th style="padding: 12px; text-align: left;">å¤‡ä»¶åç§°</th>
                                        <th style="padding: 12px; text-align: left;">æ–™å·</th>
                                        <th style="padding: 12px; text-align: left;">ä½ç½®</th>
                                        <th style="padding: 12px; text-align: left;">ä½¿ç”¨ç‡</th>
                                        <th style="padding: 12px; text-align: left;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${fault.materials.map(mat => `
                                        <tr>
                                            <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${mat.seq}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${mat.name}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${mat.code}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${mat.location}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">${mat.usage_rate || 'æ— æ•°æ®'}</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                                                <button onclick="editMaterial('${mat.id}', ${mat.seq}, '${mat.name.replace(/'/g, "\\'")}', '${mat.code.replace(/'/g, "\\'")}', '${mat.location.replace(/'/g, "\\'")}', '${mat.usage_rate || ''}')" style="background: #38a169; color: white; border: none; border-radius: 4px; padding: 4px 10px; margin-right: 4px;">ç¼–è¾‘</button>
                                                <button onclick="deleteMaterial('${mat.id}')" style="background: #f56565; color: white; border: none; border-radius: 4px; padding: 4px 10px;">åˆ é™¤</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 16px;">
                            <button onclick="addMaterialPrompt('${fault.id}')" style="background: #48bb78; color: white; border: none; border-radius: 6px; padding: 8px 16px;">+ æ·»åŠ å¤‡ä»¶</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // æ•…éšœæ“ä½œ
        function addFaultPrompt() {
            const code = prompt('è¯·è¾“å…¥æ•…éšœä»£ç /æè¿°ï¼ˆä¾‹å¦‚ï¼š2005 ç³»ç»Ÿé”™è¯¯ï¼‰');
            if (!code) return;
            callManageFunction('addFault', {
                modelCode: modelSelector.value,
                code: code,
                materials: []
            }).then(() => {
                alert('æ•…éšœæ·»åŠ æˆåŠŸï¼');
                refreshAdminPanel();
            }).catch(err => alert('æ·»åŠ å¤±è´¥ï¼š' + err.message));
        }

        function editFault(faultId, currentCode) {
            const newCode = prompt('ä¿®æ”¹æ•…éšœä»£ç /æè¿°', currentCode);
            if (!newCode || newCode === currentCode) return;
            callManageFunction('updateFault', { faultId, code: newCode })
                .then(() => {
                    alert('ä¿®æ”¹æˆåŠŸï¼');
                    refreshAdminPanel();
                }).catch(err => alert('ä¿®æ”¹å¤±è´¥ï¼š' + err.message));
        }

        function deleteFault(faultId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥æ•…éšœåŠå…¶æ‰€æœ‰å¤‡ä»¶ï¼Ÿ')) return;
            callManageFunction('deleteFault', { faultId })
                .then(() => {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    refreshAdminPanel();
                }).catch(err => alert('åˆ é™¤å¤±è´¥ï¼š' + err.message));
        }

        // å¤‡ä»¶æ“ä½œ
        function addMaterialPrompt(faultId) {
            const seq = prompt('è¯·è¾“å…¥åºå·ï¼ˆæ•°å­—ï¼‰', '1');
            if (!seq) return;
            const name = prompt('è¯·è¾“å…¥å¤‡ä»¶åç§°');
            if (!name) return;
            const code = prompt('è¯·è¾“å…¥æ–™å·');
            if (!code) return;
            const location = prompt('è¯·è¾“å…¥ä½ç½®ï¼ˆæœºå™¨äºº/åŸºç«™ï¼‰', 'æœºå™¨äºº');
            if (!location) return;
            const usage = prompt('è¯·è¾“å…¥ä½¿ç”¨ç‡ï¼ˆä¾‹å¦‚ 60.18%ï¼Œè‹¥æ— è¾“å…¥â€œæ— æ•°æ®â€ï¼‰', 'æ— æ•°æ®');
            callManageFunction('addMaterial', {
                faultId,
                seq: parseInt(seq),
                name,
                code,
                location,
                usage_rate: usage || 'æ— æ•°æ®'
            }).then(() => {
                alert('å¤‡ä»¶æ·»åŠ æˆåŠŸï¼');
                refreshAdminPanel();
            }).catch(err => alert('æ·»åŠ å¤±è´¥ï¼š' + err.message));
        }

        function editMaterial(materialId, currentSeq, currentName, currentCode, currentLocation, currentUsage) {
            const seq = prompt('ä¿®æ”¹åºå·', currentSeq);
            if (!seq) return;
            const name = prompt('ä¿®æ”¹å¤‡ä»¶åç§°', currentName);
            if (!name) return;
            const code = prompt('ä¿®æ”¹æ–™å·', currentCode);
            if (!code) return;
            const location = prompt('ä¿®æ”¹ä½ç½®', currentLocation);
            if (!location) return;
            const usage = prompt('ä¿®æ”¹ä½¿ç”¨ç‡', currentUsage || 'æ— æ•°æ®');
            callManageFunction('updateMaterial', {
                materialId,
                seq: parseInt(seq),
                name,
                code,
                location,
                usage_rate: usage || 'æ— æ•°æ®'
            }).then(() => {
                alert('å¤‡ä»¶æ›´æ–°æˆåŠŸï¼');
                refreshAdminPanel();
            }).catch(err => alert('æ›´æ–°å¤±è´¥ï¼š' + err.message));
        }

        function deleteMaterial(materialId) {
            if (!confirm('ç¡®å®šåˆ é™¤è¯¥å¤‡ä»¶ï¼Ÿ')) return;
            callManageFunction('deleteMaterial', { materialId })
                .then(() => {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    refreshAdminPanel();
                }).catch(err => alert('åˆ é™¤å¤±è´¥ï¼š' + err.message));
        }

        // Excel å¯¼å…¥å¯¼å‡º
        async function exportCurrentModelData() {
            const modelCode = modelSelector.value;
            const faults = await fetchRawFaultsByModel(modelCode);
            
            const rows = [['æ•…éšœä»£ç ', 'åºå·', 'å¤‡ä»¶åç§°', 'æ–™å·', 'ä½ç½®', 'ä½¿ç”¨ç‡']];
            faults.forEach(fault => {
                if (fault.materials.length === 0) {
                    rows.push([fault.code, '', '', '', '', '']);
                } else {
                    fault.materials.forEach(mat => {
                        rows.push([
                            fault.code,
                            mat.seq,
                            mat.name,
                            mat.code,
                            mat.location,
                            mat.usage_rate || 'æ— æ•°æ®'
                        ]);
                    });
                }
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, 'æ•…éšœå¤‡ä»¶');
            XLSX.writeFile(wb, `${modelCode}_æ•…éšœå¤‡ä»¶_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function importModelDataPrompt() {
            document.getElementById('importExcelModal').style.display = 'flex';
        }

        function cancelImport() {
            document.getElementById('importExcelModal').style.display = 'none';
            document.getElementById('excelUploadFile').value = '';
        }

        async function confirmImport() {
            const fileInput = document.getElementById('excelUploadFile');
            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©Excelæ–‡ä»¶');
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    
                    const rows = jsonData.slice(1);
                    const faultsMap = new Map();
                    rows.forEach(row => {
                        const [faultCode, seq, name, code, location, usage] = row;
                        if (!faultCode) return;
                        if (!faultsMap.has(faultCode)) {
                            faultsMap.set(faultCode, { code: faultCode, materials: [] });
                        }
                        if (name && code) {
                            faultsMap.get(faultCode).materials.push({
                                seq: parseInt(seq) || 1,
                                name,
                                code,
                                location,
                                usage_rate: usage || 'æ— æ•°æ®'
                            });
                        }
                    });
                    const faults = Array.from(faultsMap.values());
                    
                    await callManageFunction('importModelData', {
                        modelCode: modelSelector.value,
                        faults
                    });
                    alert(`å¯¼å…¥æˆåŠŸï¼å…± ${faults.length} æ¡æ•…éšœè®°å½•ã€‚`);
                    cancelImport();
                    refreshAdminPanel();
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        }

        // ç»Ÿä¸€è°ƒç”¨ Netlify Function
        async function callManageFunction(action, data) {
            const adminPassword = sessionStorage.getItem('adminPassword') || '123456';
            const response = await fetch('/.netlify/functions/manage-faults', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Password': adminPassword
                },
                body: JSON.stringify({ action, data })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'æ“ä½œå¤±è´¥');
            return result.data;
        }

        // ================ è§¦å‘é™æ€æ•°æ®æ›´æ–° ================
        async function triggerStaticDataUpdate() {
            if (!isAdminAuthenticated()) {
                alert('è¯·å…ˆè¿›è¡Œç®¡ç†å‘˜è®¤è¯ï¼');
                return;
            }
            if (!confirm('ç¡®å®šè¦æ›´æ–°é™æ€æ•°æ®å—ï¼Ÿè¿™å°†è§¦å‘ä¸€æ¬¡æ–°çš„éƒ¨ç½²ï¼Œçº¦1-2åˆ†é’Ÿåç”Ÿæ•ˆã€‚åœ¨æ­¤æœŸé—´æ—§æ•°æ®ä»ç„¶å¯ç”¨ã€‚')) return;
            try {
                const response = await fetch('/.netlify/functions/trigger-build', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': sessionStorage.getItem('adminPassword') || '123456'
                    }
                });
                const result = await response.json();
                if (result.success) {
                    alert('éƒ¨ç½²å·²è§¦å‘ï¼æ•°æ®å°†åœ¨å‡ åˆ†é’Ÿåæ›´æ–°ã€‚');
                } else {
                    throw new Error(result.error || 'è§¦å‘å¤±è´¥');
                }
            } catch (err) {
                alert('è§¦å‘å¤±è´¥ï¼š' + err.message);
            }
        }

        // ================ åŸæœ‰åé¦ˆç³»ç»Ÿã€ç»Ÿè®¡ç­‰åŠŸèƒ½ ================
        // ä»¥ä¸‹å‡½æ•°å®Œå…¨ä»åŸå§‹ä»£ç ä¸­ç§»æ¤ï¼Œç¡®ä¿åé¦ˆå’Œç»Ÿè®¡åŠŸèƒ½æ­£å¸¸

        function getOrCreateUserId() {
            try {
                let userId = localStorage.getItem('userUniqueId');
                if (!userId) {
                    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('userUniqueId', userId);
                }
                return userId;
            } catch (error) {
                console.error('è·å–ç”¨æˆ·IDå¤±è´¥:', error);
                return 'anonymous_user';
            }
        }

        async function initFeedbackSystem() {
            console.log('åˆå§‹åŒ–åé¦ˆç³»ç»Ÿ...');
            populateFeedbackModelOptions();
            await initSupabaseClient();
            await checkForUnreadReplies();
            setupFeedbackEventListeners();
            console.log('åé¦ˆç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
        }

        function populateFeedbackModelOptions() {
            const modelSelector = document.getElementById('modelSelector');
            const feedbackModelSelect = document.getElementById('feedbackModel');
            if (!modelSelector || !feedbackModelSelect) return;
            const modelOptions = modelSelector.querySelectorAll('option');
            feedbackModelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å‹å·</option>';
            modelOptions.forEach(option => {
                if (option.value) {
                    const newOption = document.createElement('option');
                    newOption.value = option.value;
                    newOption.textContent = option.textContent;
                    feedbackModelSelect.appendChild(newOption);
                }
            });
        }

        function setupFeedbackEventListeners() {
            const feedbackBtn = document.getElementById('feedbackBtn');
            const feedbackModal = document.getElementById('feedbackModal');
            const closeModalBtn = document.getElementById('closeModal');
            const cancelFeedbackBtn = document.getElementById('cancelFeedback');
            const feedbackFormElement = document.getElementById('feedbackFormElement');
            const feedbackForm = document.getElementById('feedbackForm');
            const successMessage = document.getElementById('successMessage');
            const backToFormBtn = document.getElementById('backToForm');
            const closeReplyBtn = document.getElementById('closeReply');
            const replyNotification = document.getElementById('replyNotification');
            const adminBtn = document.getElementById('adminBtn');
            const statsBtn = document.getElementById('statsBtn');
            const replyAdminBtn = document.getElementById('replyAdminBtn');

            if (feedbackBtn) {
                feedbackBtn.addEventListener('click', function() {
                    const modelSelector = document.getElementById('modelSelector');
                    const feedbackModelSelect = document.getElementById('feedbackModel');
                    if (modelSelector && feedbackModelSelect) feedbackModelSelect.value = modelSelector.value;
                    if (feedbackModal) feedbackModal.classList.add('active');
                });
            }
            function closeFeedbackModal() {
                if (feedbackModal) feedbackModal.classList.remove('active');
                if (feedbackFormElement) feedbackFormElement.reset();
                if (feedbackForm) feedbackForm.style.display = 'block';
                if (successMessage) successMessage.classList.remove('active');
            }
            if (closeModalBtn) closeModalBtn.addEventListener('click', closeFeedbackModal);
            if (cancelFeedbackBtn) cancelFeedbackBtn.addEventListener('click', closeFeedbackModal);
            if (feedbackModal) {
                feedbackModal.addEventListener('click', function(e) {
                    if (e.target === feedbackModal) closeFeedbackModal();
                });
            }
            if (feedbackFormElement) {
                feedbackFormElement.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const supabase = await getSupabase();
                    if (!supabase) { alert('æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚'); return; }
                    const model = document.getElementById('feedbackModel') ? document.getElementById('feedbackModel').value : '';
                    const problem = document.getElementById('feedbackProblem') ? document.getElementById('feedbackProblem').value : '';
                    const suggestion = document.getElementById('feedbackSuggestion') ? document.getElementById('feedbackSuggestion').value : '';
                    const userId = getOrCreateUserId();
                    if (!model || !problem.trim()) { alert('è¯·å¡«å†™å‹å·å’Œå…·ä½“é—®é¢˜ã€‚'); return; }
                    const feedback = {
                        user_id: userId,
                        model: model,
                        problem: problem.trim(),
                        suggestion: suggestion ? suggestion.trim() : '',
                        status: 'pending',
                        reply_read: false
                    };
                    try {
                        const { data, error } = await supabase.from('feedbacks').insert([feedback]);
                        if (error) throw error;
                        console.log('åé¦ˆå·²ä¿å­˜åˆ°Supabase:', data);
                        if (feedbackForm) feedbackForm.style.display = 'none';
                        if (successMessage) successMessage.classList.add('active');
                        recordVisit();
                    } catch (error) {
                        console.error('ä¿å­˜åé¦ˆæ—¶å‡ºé”™:', error);
                        alert('æäº¤åé¦ˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚é”™è¯¯è¯¦æƒ…ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                });
            }
            if (backToFormBtn) {
                backToFormBtn.addEventListener('click', function() {
                    if (feedbackFormElement) feedbackFormElement.reset();
                    if (feedbackForm) feedbackForm.style.display = 'block';
                    if (successMessage) successMessage.classList.remove('active');
                });
            }
            if (closeReplyBtn) {
                closeReplyBtn.addEventListener('click', async function() {
                    if (replyNotification) replyNotification.style.display = 'none';
                    const feedbackId = replyNotification.dataset.feedbackId;
                    if (feedbackId) {
                        await markReplyAsRead(feedbackId);
                    }
                });
            }

            if (adminBtn) {
                adminBtn.addEventListener('click', async function() {
                    if (!isAdminAuthenticated()) {
                        showAdminPanel();
                    } else {
                        await exportFeedbackAsAdmin();
                    }
                });
            }
            
            if (statsBtn) {
                statsBtn.addEventListener('click', exportStats);
            }

            if (replyAdminBtn) {
                replyAdminBtn.addEventListener('click', async function() {
                    if (!isAdminAuthenticated()) {
                        showAdminPanel();
                    } else {
                        await replyFeedbackAsAdmin();
                    }
                });
            }
        }

        async function exportFeedbackAsAdmin() {
            if (typeof XLSX === 'undefined') {
                alert('å¯¼å‡ºåŠŸèƒ½éœ€è¦åŠ è½½Excelåº“ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚');
                return;
            }

            const adminPassword = sessionStorage.getItem('adminPassword') || '123456';
            try {
                const response = await fetch('/.netlify/functions/export-feedback', {
                    headers: { 'X-Admin-Password': adminPassword }
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.error);
                
                generateExcelFromFeedbackData(result.data);
            } catch (error) {
                console.error('å¯¼å‡ºåé¦ˆæ•°æ®å¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        function generateExcelFromFeedbackData(data) {
            if (!data || data.length === 0) {
                alert('æš‚æ— åé¦ˆæ•°æ®å¯å¯¼å‡ºã€‚');
                return;
            }
            
            const excelData = [];
            excelData.push(['åºå·', 'åé¦ˆID', 'ç”¨æˆ·ID', 'å‹å·', 'å…·ä½“é—®é¢˜', 'åŠŸèƒ½å»ºè®®', 'çŠ¶æ€', 'å›å¤å†…å®¹', 'å›å¤æ—¶é—´', 'æäº¤æ—¶é—´']);
            
            data.forEach((feedback, index) => {
                excelData.push([
                    index + 1,
                    feedback.id,
                    feedback.user_id || '',
                    feedback.model || '',
                    feedback.problem || '',
                    feedback.suggestion || '',
                    feedback.status === 'pending' ? 'å¾…å¤„ç†' : 
                    feedback.status === 'reviewed' ? 'å·²æŸ¥çœ‹' : 'å·²è§£å†³',
                    feedback.reply || '',
                    formatDate(feedback.reply_time) || '',
                    formatDate(feedback.created_at)
                ]);
            });
            
            const totalCount = data.length;
            const pendingCount = data.filter(f => f.status === 'pending').length;
            const reviewedCount = data.filter(f => f.status === 'reviewed').length;
            const resolvedCount = data.filter(f => f.status === 'resolved').length;
            
            excelData.push([]);
            excelData.push(['ç»Ÿè®¡ä¿¡æ¯', '', '', '', '', '', '', '', '', '']);
            excelData.push(['æ€»åé¦ˆæ•°', totalCount, '', '', '', '', '', '', '', '']);
            excelData.push(['å¾…å¤„ç†', pendingCount, '', '', '', '', '', '', '', '']);
            excelData.push(['å·²æŸ¥çœ‹', reviewedCount, '', '', '', '', '', '', '', '']);
            excelData.push(['å·²è§£å†³', resolvedCount, '', '', '', '', '', '', '', '']);
            excelData.push(['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN'), '', '', '', '', '', '', '', '']);
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            ws['!cols'] = [
                {wch: 8}, {wch: 25}, {wch: 20}, {wch: 15}, {wch: 50},
                {wch: 50}, {wch: 10}, {wch: 50}, {wch: 20}, {wch: 20}
            ];
            XLSX.utils.book_append_sheet(wb, ws, "åé¦ˆæ•°æ®");
            
            const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});
            function s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }
            const blob = new Blob([s2ab(wbout)], {type: "application/octet-stream"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const today = new Date().toISOString().split('T')[0];
            a.download = `æ•…éšœæŸ¥è¯¢åé¦ˆ_${today}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            alert(`æˆåŠŸå¯¼å‡º ${totalCount} æ¡åé¦ˆæ•°æ®åˆ°Excelæ–‡ä»¶ï¼\n\nå¾…å¤„ç†: ${pendingCount} æ¡\nå·²æŸ¥çœ‹: ${reviewedCount} æ¡\nå·²è§£å†³: ${resolvedCount} æ¡`);
        }

        async function replyFeedbackAsAdmin() {
            const adminPassword = sessionStorage.getItem('adminPassword') || '123456';
            
            const feedbackId = prompt('è¯·è¾“å…¥è¦å›å¤çš„åé¦ˆIDï¼ˆå¯ä»å¯¼å‡ºExcelä¸­è·å–ï¼‰ï¼š');
            if (!feedbackId) return;
            
            const replyText = prompt('è¯·è¾“å…¥å›å¤å†…å®¹ï¼š');
            if (!replyText) return;
            
            try {
                const response = await fetch('/.netlify/functions/reply-feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': adminPassword
                    },
                    body: JSON.stringify({ feedbackId, reply: replyText })
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.error);
                
                alert('å›å¤æˆåŠŸï¼ç”¨æˆ·å°†åœ¨ä¸‹æ¬¡æ‰“å¼€é¡µé¢æ—¶çœ‹åˆ°å›å¤é€šçŸ¥ã€‚');
            } catch (error) {
                console.error('å›å¤åé¦ˆå¤±è´¥:', error);
                alert('å›å¤å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        async function checkForUnreadReplies() {
            const supabase = await getSupabase();
            if (!supabase) return;
            try {
                const userId = getOrCreateUserId();
                
                const { data: allReplies, error: allError } = await supabase
                    .from('feedbacks')
                    .select('*')
                    .eq('user_id', userId)
                    .not('reply', 'is', null)
                    .order('created_at', { ascending: false });

                if (allError) throw allError;

                const unreadReplies = allReplies ? allReplies.filter(f => f.reply_read === false) : [];

                const viewReplyBtn = document.getElementById('viewReplyBtn');
                if (viewReplyBtn) {
                    if (allReplies && allReplies.length > 0) {
                        viewReplyBtn.style.display = 'block';
                        viewReplyBtn.textContent = `ğŸ“¨ é—®é¢˜å›å¤ (${allReplies.length})`;
                        viewReplyBtn.onclick = function() { showAllRepliesModal(allReplies); };
                    } else {
                        viewReplyBtn.style.display = 'none';
                    }
                }

                if (unreadReplies.length > 0) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const feedbackId = urlParams.get('feedback_id');
                    let targetFeedback = null;
                    if (feedbackId) {
                        targetFeedback = unreadReplies.find(f => f.id === feedbackId);
                    }
                    if (!targetFeedback) {
                        targetFeedback = unreadReplies[0];
                    }
                    showReplyNotification(targetFeedback);
                }
            } catch (error) {
                console.error('æ£€æŸ¥å›å¤æ—¶å‡ºé”™:', error);
            }
        }

        function showReplyNotification(feedback) {
            const replyNotification = document.getElementById('replyNotification');
            const replyContent = document.getElementById('replyContent');
            const replyTime = document.getElementById('replyTime');
            if (replyNotification && feedback.reply) {
                if (replyContent) replyContent.textContent = feedback.reply;
                if (replyTime) replyTime.textContent = `å›å¤æ—¶é—´ï¼š${formatDate(feedback.reply_time)}`;
                replyNotification.style.display = 'block';
                replyNotification.dataset.feedbackId = feedback.id;
                
                setTimeout(async () => {
                    if (replyNotification.style.display === 'block') {
                        replyNotification.style.display = 'none';
                        await markReplyAsRead(feedback.id);
                    }
                }, 10000);
            }
        }

        async function markReplyAsRead(feedbackId) {
            const supabase = await getSupabase();
            if (!supabase) return;
            try {
                await supabase.from('feedbacks').update({ reply_read: true }).eq('id', feedbackId);
                console.log('å›å¤å·²æ ‡è®°ä¸ºå·²è¯»:', feedbackId);
            } catch (error) {
                console.error('æ ‡è®°å›å¤ä¸ºå·²è¯»æ—¶å‡ºé”™:', error);
            }
        }

        function showAllRepliesModal(feedbacks) {
            const modal = document.createElement('div');
            modal.className = 'feedback-modal active';
            modal.innerHTML = `
                <div class="feedback-content" style="max-width: 600px;">
                    <div class="feedback-header">
                        <h2>ğŸ“¨ æˆ‘çš„å›å¤</h2>
                        <button class="close-modal" id="closeAllRepliesModal">&times;</button>
                    </div>
                    <div class="feedback-body" style="max-height: 400px; overflow-y: auto;">
                        ${feedbacks.map((feedback, index) => `
                            <div class="reply-item" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span class="feedback-model" style="background: #4299e1; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px;">
                                        ${feedback.model || 'æœªçŸ¥å‹å·'}
                                    </span>
                                    <span style="color: #718096; font-size: 14px;">
                                        ${formatDate(feedback.created_at)}
                                    </span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>æˆ‘çš„é—®é¢˜ï¼š</strong>
                                    <div style="background: #f7fafc; padding: 10px; border-radius: 5px; margin-top: 5px; white-space: pre-wrap; word-wrap: break-word;">
                                        ${feedback.problem || ''}
                                    </div>
                                </div>
                                <div>
                                    <strong style="color: #48bb78;">ç®¡ç†å‘˜å›å¤ï¼š</strong>
                                    <div class="reply-content" style="background: #c6f6d5; padding: 10px; border-radius: 5px; margin-top: 5px; white-space: pre-wrap; word-wrap: break-word; overflow-y: auto; max-height: 200px;">
                                        ${feedback.reply || ''}
                                    </div>
                                    <div style="color: #718096; font-size: 12px; text-align: right; margin-top: 5px;">
                                        ${formatDate(feedback.reply_time)}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            const closeBtn = modal.querySelector('#closeAllRepliesModal');
            closeBtn.addEventListener('click', async function() {
                modal.remove();
                const unreadIds = feedbacks.filter(f => f.reply_read === false).map(f => f.id);
                if (unreadIds.length > 0) {
                    const supabase = await getSupabase();
                    if (supabase) {
                        await supabase.from('feedbacks').update({ reply_read: true }).in('id', unreadIds);
                    }
                }
            });

            modal.addEventListener('click', async function(e) {
                if (e.target === modal) {
                    modal.remove();
                    const unreadIds = feedbacks.filter(f => f.reply_read === false).map(f => f.id);
                    if (unreadIds.length > 0) {
                        const supabase = await getSupabase();
                        if (supabase) {
                            await supabase.from('feedbacks').update({ reply_read: true }).in('id', unreadIds);
                        }
                    }
                }
            });
        }

        async function recordVisit() {
            const supabase = await getSupabase();
            if (!supabase) return;
            const userId = getOrCreateUserId();
            const today = new Date().toISOString().split('T')[0];
            try {
                const { data: existingStats, error: fetchError } = await supabase
                    .from('site_stats')
                    .select('*')
                    .eq('date', today)
                    .single();
                if (fetchError && fetchError.code !== 'PGRST116') {
                    console.error('æŸ¥è¯¢ç»Ÿè®¡è®°å½•é”™è¯¯:', fetchError);
                    return;
                }
                if (existingStats) {
                    const clicks = (existingStats.clicks || 0) + 1;
                    let users = existingStats.users || [];
                    if (!Array.isArray(users)) users = [];
                    if (!users.includes(userId)) users.push(userId);
                    await supabase.from('site_stats').update({ clicks, users, updated_at: new Date().toISOString() }).eq('id', existingStats.id);
                } else {
                    await supabase.from('site_stats').insert([{ date: today, clicks: 1, users: [userId], created_at: new Date().toISOString() }]);
                }
                console.log(`è®¿é—®ç»Ÿè®¡å·²è®°å½•åˆ°Supabase - æ—¥æœŸ: ${today}`);
            } catch (error) {
                console.error('è®°å½•è®¿é—®ç»Ÿè®¡æ—¶å‡ºé”™:', error);
            }
        }

        async function exportStats() {
            if (typeof XLSX === 'undefined') { alert('å¯¼å‡ºåŠŸèƒ½éœ€è¦åŠ è½½Excelåº“ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚'); return; }
            const supabase = await getSupabase();
            if (!supabase) { alert('æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ï¼Œæ— æ³•å¯¼å‡ºç»Ÿè®¡ã€‚'); return; }
            try {
                const { data, error } = await supabase.from('site_stats').select('*').order('date', { ascending: false });
                if (error) throw error;
                if (!data || data.length === 0) { alert('æš‚æ— ç»Ÿè®¡æ•°æ®ã€‚'); return; }
                const excelData = [['æ—¥æœŸ', 'ç‚¹å‡»æ¬¡æ•°', 'ç‹¬ç«‹ç”¨æˆ·æ•°']];
                const sortedData = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
                let totalClicks = 0, totalUsers = new Set();
                sortedData.forEach(stat => {
                    const userCount = Array.isArray(stat.users) ? stat.users.length : 0;
                    excelData.push([stat.date, stat.clicks, userCount]);
                    totalClicks += stat.clicks || 0;
                    if (Array.isArray(stat.users)) stat.users.forEach(userId => totalUsers.add(userId));
                });
                excelData.push([], ['æ€»è®¡', totalClicks, totalUsers.size], ['å¯¼å‡ºæ—¶é—´', new Date().toLocaleString('zh-CN'), '']);
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                ws['!cols'] = [{wch:12},{wch:12},{wch:12}];
                XLSX.utils.book_append_sheet(wb, ws, "ç½‘ç«™ç»Ÿè®¡");
                const wbout = XLSX.write(wb, {bookType:'xlsx', type:'binary'});
                function s2ab(s) { const buf = new ArrayBuffer(s.length); const view = new Uint8Array(buf); for (let i=0; i<s.length; i++) view[i]=s.charCodeAt(i)&0xFF; return buf; }
                const blob = new Blob([s2ab(wbout)], {type:"application/octet-stream"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ç½‘ç«™ç»Ÿè®¡_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 100);
            } catch (error) {
                console.error('å¯¼å‡ºç»Ÿè®¡æ—¶å‡ºé”™:', error);
                alert('å¯¼å‡ºç»Ÿè®¡æ—¶å‡ºé”™ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            try { return new Date(dateString).toLocaleString('zh-CN'); } catch { return dateString; }
        }

        // ================ é¡µé¢åˆå§‹åŒ– ================
        window.addEventListener('load', async function() {
            // åˆå§‹åŒ–é™æ€æ•°æ®
            const defaultModel = modelSelector.value;
            currentData = getFaultsByModel(defaultModel);
            updatePlaceholder();
            updateModelIndicator();
            setLoading(false);

            // åˆå§‹åŒ–åé¦ˆç³»ç»Ÿã€ç»Ÿè®¡ç­‰
            setTimeout(async function() {
                await initFeedbackSystem();
                await recordVisit();

                // ç®¡ç†å‘˜æŒ‰é’®æ˜¾ç¤º
                if (isAdminAuthenticated()) {
                    if (adminBtn) adminBtn.style.display = 'block';
                    if (statsBtn) statsBtn.style.display = 'block';
                    if (replyAdminBtn) replyAdminBtn.style.display = 'block';
                    // æ•°æ®ç®¡ç†æŒ‰é’®
                    if (!document.getElementById('dataManageBtn')) {
                        const dataManageBtn = document.createElement('button');
                        dataManageBtn.id = 'dataManageBtn';
                        dataManageBtn.className = 'reply-admin-btn';
                        dataManageBtn.style.bottom = '320px';
                        dataManageBtn.style.background = 'linear-gradient(135deg, #805ad5, #6b46c1)';
                        dataManageBtn.innerText = 'ğŸ“ æ•°æ®ç®¡ç†';
                        dataManageBtn.onclick = showAdminDataPanel;
                        document.body.appendChild(dataManageBtn);
                    }
                    document.getElementById('dataManageBtn').style.display = 'block';
                }
            }, 500);
        });

        console.log('è„šæœ¬åŠ è½½å®Œæˆï¼Œæ‰€æœ‰åŠŸèƒ½å·²å°±ç»ª');
    </script>
</body>
</html>